<?xml version="1.0" encoding="UTF-8" ?>
<container
        xmlns="http://symfony.com/schema/dic/services"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://symfony.com/schema/dic/services
                        http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="ekyna_admin.security.remember_me">_admin_remember_me</parameter>
    </parameters>

    <services>

        <!-- Controllers -->
        <service id="Ekyna\Bundle\AdminBundle\Controller\DashboardController">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Dashboard\Dashboard"/>
            <argument type="service" id="Symfony\Component\Templating\EngineInterface"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Controller\ToolbarController">
            <argument type="service" id="Ekyna\Component\Resource\Search\Search"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Search\SearchHelper"/>
            <argument type="service" id="Symfony\Component\Routing\Generator\UrlGeneratorInterface"/>
            <argument type="service" id="Symfony\Component\EventDispatcher\EventDispatcherInterface"/>
        </service>

        <!-- Event listeners -->
        <service id="Ekyna\Bundle\AdminBundle\EventListener\UserEventSubscriber">
            <argument type="service" id="security.password_encoder"/>
            <argument type="service" id="security.token_storage"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\EventListener\GroupEventSubscriber">
            <argument type="service" id="security.token_storage"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\EventListener\SecurityEventSubscriber">
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Mailer\AdminMailer"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Search repository -->
        <service id="ekyna_admin.user.search"
                 class="Ekyna\Bundle\AdminBundle\Service\Search\UserRepository">
            <argument type="service" id="fos_elastica.index.ekyna_admin_user.doc"/>
            <argument type="service" id="fos_elastica.elastica_to_model_transformer.ekyna_admin_user.doc"/>
            <call method="setGroupRepository">
                <argument type="service" id="ekyna_admin.group.repository"/>
            </call>
            <!--<tag name="ekyna_resource.search" resource="ekyna_admin.user"/>-->
        </service>

        <!-- User mailer registry -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Mailer\MailerFactory">
            <argument type="service" id="swiftmailer.mailer.default"/>
            <argument type="service" id="swiftmailer.mailer.default.transport.eventdispatcher"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument type="service" id="router.request_context" on-invalid="null"/>
        </service>

        <!-- Admin mailer -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Mailer\AdminMailer">
            <argument type="service" id="ekyna_setting.manager"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="templating"/>
            <argument type="service" id="router"/>
            <argument type="service" id="swiftmailer.mailer.default"/>
        </service>

        <!-- Settings Schema -->
        <service id="Ekyna\Bundle\AdminBundle\Settings\GeneralSettingsSchema">
            <tag name="ekyna_setting.schema" namespace="general" position="0"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Settings\NotificationSettingsSchema">
            <tag name="ekyna_setting.schema" namespace="notification" position="1"/>
        </service>

        <!-- Security token authenticator -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Security\TokenAuthenticator">
            <argument type="service" id="ekyna_admin.user.repository"/>
        </service>

        <!-- Security user provider -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="security.token_storage"/>
        </service>

        <!-- Security login manager -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Security\LoginManager">
            <argument type="service" id="Symfony\Component\Security\Core\User\UserCheckerInterface"/>
            <argument type="service" id="Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface"/>
            <argument type="service" id="Symfony\Component\HttpFoundation\RequestStack"/>
            <argument type="service" id="Symfony\Component\Security\Http\Session\SessionAuthenticationStrategyInterface"/>
        </service>

        <!-- Admin Menus -->
        <service id="Ekyna\Bundle\AdminBundle\Menu\MenuPool"/>
        <service id="Ekyna\Bundle\AdminBundle\Menu\MenuBuilder">
            <argument type="service" id="knp_menu.factory"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Menu\MenuPool"/>
            <argument type="service" id="security.authorization_checker"/>
        </service>
        <service id="ekyna_admin.menu.side"
                 class="Knp\Menu\MenuItem">
            <factory service="Ekyna\Bundle\AdminBundle\Menu\MenuBuilder" method="createSideMenu"/>
            <argument type="service" id="request_stack"/>
            <tag name="knp_menu.menu" alias="ekyna_admin.side"/>
        </service>
        <service id="ekyna_admin.menu.breadcrumb"
                 class="Knp\Menu\MenuItem">
            <factory service="Ekyna\Bundle\AdminBundle\Menu\MenuBuilder" method="createBreadcrumb"/>
            <argument type="service" id="request_stack"/>
            <tag name="knp_menu.menu" alias="ekyna_admin.breadcrumb"/>
        </service>

        <!-- Form Types Extensions -->
        <service id="Ekyna\Bundle\AdminBundle\Form\Extension\AdminTypeExtension" public="false">
            <argument type="service" id="Symfony\Component\Security\Core\Authorization\AuthorizationCheckerInterface"/>
            <tag name="form.type_extension" extended-type="Symfony\Component\Form\Extension\Core\Type\FormType"/>
        </service>

        <!-- Form Types -->
        <service id="Ekyna\Bundle\AdminBundle\Form\Type\ResourceType">
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_admin.user.form_type"
                 class="Ekyna\Bundle\AdminBundle\Form\Type\UserType">
            <argument type="service" id="security.authorization_checker"/>
            <argument>%ekyna_admin.user.class%</argument>
            <argument>%ekyna_admin.group.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Form\Type\UserChoiceType">
            <argument>%ekyna_admin.user.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Form\Type\UserSearchType">
            <argument>%ekyna_admin.user.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Table types -->
        <service id="ekyna_admin.user.table_type"
                 class="Ekyna\Bundle\AdminBundle\Table\Type\UserType">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument>%ekyna_admin.user.class%</argument>
            <tag name="table.type"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Table\Type\Column\ConstantChoiceType">
            <argument type="service" id="Symfony\Component\Translation\TranslatorInterface"/>
            <tag name="table.column_type"/>
        </service>
        <service class="Ekyna\Bundle\AdminBundle\Table\Type\Column\ActionsTypeExtension">
            <argument type="service" id="security.authorization_checker"/>
            <tag name="table.column_type_extension"
                 extended_type="Ekyna\Bundle\TableBundle\Extension\Type\Column\ActionsType"/>
        </service>
        <service class="Ekyna\Bundle\AdminBundle\Table\Type\Column\EntityTypeExtension">
            <argument type="service" id="security.authorization_checker"/>
            <tag name="table.column_type_extension"
                 extended_type="Ekyna\Component\Table\Bridge\Doctrine\ORM\Type\Column\EntityType"/>
        </service>

        <!-- Table profile storage -->
        <service id="Ekyna\Bundle\AdminBundle\Table\Context\Profile\UserStorage">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument type="service" id="doctrine.orm.entity_manager"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Table\Context\TableTypeExtension">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Table\Context\Profile\UserStorage"/>
            <tag name="table.type_extension" extended_type="Ekyna\Component\Table\Extension\Core\Type\TableType"/>
        </service>

        <!-- Resource search helper -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Search\SearchHelper">
            <argument type="service" id="Symfony\Component\HttpFoundation\Session\SessionInterface"/>
            <argument type="service" id="Symfony\Component\Templating\EngineInterface"/>
            <argument>%ekyna_resource.search_resources%</argument>
            <tag name="twig.runtime"/>
        </service>

        <!-- Resource Helper -->
        <service id="Ekyna\Bundle\AdminBundle\Helper\ResourceHelper" lazy="true">
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="router"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
            <tag name="twig.runtime"/>
        </service>
        <service alias="Ekyna\Bundle\AdminBundle\Helper\ResourceHelper"
                 id="ekyna_admin.helper.resource_helper"/>

        <!-- Pin Helper -->
        <service id="Ekyna\Bundle\AdminBundle\Helper\PinHelper">
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Helper\ResourceHelper"/>
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
            <tag name="twig.runtime"/>
        </service>

        <!-- Show -->
        <service id="Ekyna\Bundle\AdminBundle\Show\Extension\Core\CoreExtension"
                 public="false"/>
        <service id="Ekyna\Bundle\AdminBundle\Show\Extension\DependencyInjection\DependencyInjectionExtension"
                 lazy="true"
                 public="false">
            <argument type="service" id="service_container"/>
            <argument type="collection"/><!-- Replaced by compiler pass -->
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Show\Registry"
                 public="false">
            <argument type="collection">
                <argument type="service" id="Ekyna\Bundle\AdminBundle\Show\Extension\Core\CoreExtension"/>
                <argument type="service" id="Ekyna\Bundle\AdminBundle\Show\Extension\DependencyInjection\DependencyInjectionExtension"/>
            </argument>
        </service>
        <service class="Ekyna\Bundle\AdminBundle\Show\Extension\Core\Type\TranslationsType">
            <argument>%locales%</argument>
            <tag name="ekyna_admin.show.type" alias="translations"/>
        </service>
        <service class="Ekyna\Bundle\AdminBundle\Show\Extension\Core\Type\ConstantChoiceType">
            <argument type="service" id="Symfony\Component\Translation\TranslatorInterface"/>
            <tag name="ekyna_admin.show.type" alias="constant_choice"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Show\Renderer">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Show\Registry"/>
            <argument type="service" id="Twig\Environment"/>
            <tag name="twig.runtime"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Show\RendererInterface"
                 alias="Ekyna\Bundle\AdminBundle\Show\Renderer" />

        <!-- Serialization -->
        <service id="ekyna_admin.user.normalizer"
                 class="Ekyna\Bundle\AdminBundle\Service\Serializer\UserNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>

        <!-- Dashboard -->
        <service id="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Registry">
            <argument type="collection"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Factory">
            <argument id="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Registry" type="service"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Dashboard\Factory">
            <argument id="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Factory" type="service"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Dashboard\Widget\ShortcutsWidgetType">
            <argument id="Ekyna\Bundle\AdminBundle\Menu\MenuPool" type="service"/>
            <argument id="ekyna_resource.configuration_registry" type="service"/>
            <argument id="Symfony\Component\Security\Core\Authorization\AuthorizationCheckerInterface" type="service"/>
            <argument id="Symfony\Component\Routing\RouterInterface" type="service"/>
            <tag name="ekyna_admin.dashboard.widget_type" alias="admin_shortcuts"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Dashboard\Dashboard">
            <factory service="Ekyna\Bundle\AdminBundle\Dashboard\Factory" method="create"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Service\Renderer\DashboardRenderer">
            <argument type="service" id="Twig\Environment" />
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="twig.runtime"/>
        </service>

        <!-- Admin renderer -->
        <service id="Ekyna\Bundle\AdminBundle\Service\Renderer\AdminRenderer">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Helper\ResourceHelper"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Helper\PinHelper"/>
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="ekyna_core.ui.renderer"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="twig.runtime"/>
        </service>

        <!-- Twig Extensions -->
        <service id="Ekyna\Bundle\AdminBundle\Twig\AdminExtension">
            <tag name="twig.extension"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Twig\ShowExtension">
            <tag name="twig.extension"/>
        </service>

        <!-- Commands -->
        <service id="Ekyna\Bundle\AdminBundle\Command\CreateUserCommand">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="ekyna_admin.user.operator"/>
            <argument type="service" id="ekyna_admin.group.repository"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Command\ChangeUserPasswordCommand">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="ekyna_admin.user.operator"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\AdminBundle\Command\GenerateUserApiTokenCommand">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="ekyna_admin.user.operator"/>
            <tag name="console.command"/>
        </service>

    </services>

</container>
