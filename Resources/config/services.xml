<?xml version="1.0" encoding="UTF-8" ?>
<container
        xmlns="http://symfony.com/schema/dic/services"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://symfony.com/schema/dic/services
                        http://symfony.com/schema/dic/services/services-1.0.xsd">


    <parameters>
        <parameter key="ekyna_admin.user.search_repository.class">Ekyna\Bundle\AdminBundle\Service\Search\UserRepository</parameter>
        <parameter key="ekyna_admin.security.remember_me">_admin_remember_me</parameter>
    </parameters>

    <services>

        <!-- Event listeners -->
        <service id="ekyna_admin.user.event_subscriber"
                 class="Ekyna\Bundle\AdminBundle\EventListener\UserEventSubscriber">
            <argument type="service" id="security.password_encoder"/>
            <argument type="service" id="security.token_storage"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <service id="ekyna_admin.group.event_subscriber"
                 class="Ekyna\Bundle\AdminBundle\EventListener\GroupEventSubscriber">
            <argument type="service" id="security.token_storage"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <service id="ekyna_admin.security.event_subscriber"
                 class="Ekyna\Bundle\AdminBundle\EventListener\SecurityEventSubscriber">
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="ekyna_admin.security.user_provider"/>
            <argument type="service" id="ekyna_admin.admin_mailer"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- User mailer registry -->
        <service id="ekyna_admin.mailer_factory"
                 class="Ekyna\Bundle\AdminBundle\Service\Mailer\MailerFactory">
            <argument type="service" id="swiftmailer.mailer.default"/>
            <argument type="service" id="swiftmailer.mailer.default.transport.eventdispatcher"/>
            <argument type="service" id="ekyna_admin.security.user_provider"/>
            <argument type="service" id="router.request_context" on-invalid="null"/>
        </service>

        <!-- Admin mailer -->
        <service id="ekyna_admin.admin_mailer"
                 class="Ekyna\Bundle\AdminBundle\Service\Mailer\AdminMailer">
            <argument type="service" id="ekyna_setting.manager"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="templating"/>
            <argument type="service" id="router"/>
            <argument type="service" id="swiftmailer.mailer.default"/>
        </service>

        <!-- Settings Schema -->
        <service id="ekyna_admin.settings.general"
                 class="Ekyna\Bundle\AdminBundle\Settings\GeneralSettingsSchema">
            <tag name="ekyna_setting.schema" namespace="general" position="0"/>
        </service>
        <service id="ekyna_admin.settings.notification"
                 class="Ekyna\Bundle\AdminBundle\Settings\NotificationSettingsSchema">
            <tag name="ekyna_setting.schema" namespace="notification" position="1"/>
        </service>

        <!-- Security user provider -->
        <service id="ekyna_admin.security.user_provider"
                 class="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="security.token_storage"/>
        </service>

        <!-- Admin Menus -->
        <service id="ekyna_admin.menu.pool"
                 class="Ekyna\Bundle\AdminBundle\Menu\MenuPool"/>
        <service id="ekyna_admin.menu.builder"
                 class="Ekyna\Bundle\AdminBundle\Menu\MenuBuilder">
            <argument type="service" id="knp_menu.factory"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="ekyna_admin.menu.pool"/>
            <argument type="service" id="security.authorization_checker"/>
        </service>
        <service id="ekyna_admin.menu.side"
                 class="Knp\Menu\MenuItem">
            <factory service="ekyna_admin.menu.builder" method="createSideMenu"/>
            <argument type="service" id="request_stack"/>
            <tag name="knp_menu.menu" alias="ekyna_admin.side"/>
        </service>
        <service id="ekyna_admin.menu.breadcrumb"
                 class="Knp\Menu\MenuItem">
            <factory service="ekyna_admin.menu.builder" method="createBreadcrumb"/>
            <argument type="service" id="request_stack"/>
            <tag name="knp_menu.menu" alias="ekyna_admin.breadcrumb"/>
        </service>

        <!-- Form Types Extensions -->
        <service id="ekyna_admin.form.admin_extension"
                 class="Ekyna\Bundle\AdminBundle\Form\Extension\AdminTypeExtension">
            <tag name="form.type_extension" extended-type="Symfony\Component\Form\Extension\Core\Type\FormType"/>
        </service>

        <!-- Form Types -->
        <service id="ekyna_admin.resource.form_type"
                 class="Ekyna\Bundle\AdminBundle\Form\Type\ResourceType">
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="security.authorization_checker"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_admin.user.form_type"
                 class="Ekyna\Bundle\AdminBundle\Form\Type\UserType">
            <argument type="service" id="security.authorization_checker"/>
            <argument>%ekyna_admin.user.class%</argument>
            <argument>%ekyna_admin.group.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_admin.user_choice.form_type"
                 class="Ekyna\Bundle\AdminBundle\Form\Type\UserChoiceType">
            <argument>%ekyna_admin.user.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_admin.user_search.form_type"
                 class="Ekyna\Bundle\AdminBundle\Form\Type\UserSearchType">
            <argument>%ekyna_admin.user.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Table types -->
        <service id="ekyna_admin.user.table_type"
                 class="Ekyna\Bundle\AdminBundle\Table\Type\UserType">
            <argument type="service" id="ekyna_admin.security.user_provider"/>
            <argument>%ekyna_admin.user.class%</argument>
            <argument>%ekyna_admin.group.class%</argument>
            <tag name="table.type"/>
        </service>
        <service id="ekyna_admin.table.actions_column_type_extension"
                 class="Ekyna\Bundle\AdminBundle\Table\Type\Column\ActionsTypeExtension">
            <argument type="service" id="security.authorization_checker"/>
            <tag name="table.column_type_extension"
                 extended_type="Ekyna\Bundle\TableBundle\Extension\Type\Column\ActionsType"/>
        </service>
        <service id="ekyna_admin.table.entity_column_type_extension"
                 class="Ekyna\Bundle\AdminBundle\Table\Type\Column\EntityTypeExtension">
            <argument type="service" id="security.authorization_checker"/>
            <tag name="table.column_type_extension"
                 extended_type="Ekyna\Component\Table\Bridge\Doctrine\ORM\Type\Column\EntityType"/>
        </service>

        <!-- Table profile storage -->
        <service id="ekyna_admin.table.profile_storage"
                 class="Ekyna\Bundle\AdminBundle\Table\Context\Profile\UserStorage">
            <argument type="service" id="ekyna_admin.security.user_provider"/>
            <argument type="service" id="doctrine.orm.entity_manager"/>
        </service>
        <service id="ekyna_admin.user_storage.table_type_extension"
                 class="Ekyna\Bundle\AdminBundle\Table\Context\TableTypeExtension">
            <argument type="service" id="ekyna_admin.table.profile_storage"/>
            <tag name="table.type_extension" extended_type="Ekyna\Component\Table\Extension\Core\Type\TableType"/>
        </service>

        <!-- Resource Helper -->
        <service id="ekyna_admin.helper.resource_helper"
                 class="Ekyna\Bundle\AdminBundle\Helper\ResourceHelper"
                 lazy="true">
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="router"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
        </service>

        <!-- Pin Helper -->
        <service id="ekyna_admin.helper.pin_helper"
                 class="Ekyna\Bundle\AdminBundle\Helper\PinHelper">
            <argument type="service" id="ekyna_resource.configuration_registry"/>
            <argument type="service" id="ekyna_admin.security.user_provider"/>
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
        </service>

        <!-- Show -->
        <service id="ekyna_admin.show.extension.core"
                 class="Ekyna\Bundle\AdminBundle\Show\Extension\Core\CoreExtension"
                 public="false"/>
        <service id="ekyna_admin.show.extension.dependency_injection"
                 class="Ekyna\Bundle\AdminBundle\Show\Extension\DependencyInjection\DependencyInjectionExtension"
                 lazy="true"
                 public="false">
            <argument type="service" id="service_container"/>
            <argument type="collection"/><!-- Replaced by compiler pass -->
        </service>
        <service id="ekyna_admin.show.registry"
                 class="Ekyna\Bundle\AdminBundle\Show\Registry"
                 public="false">
            <argument type="collection">
                <argument type="service" id="ekyna_admin.show.extension.core"/>
                <argument type="service" id="ekyna_admin.show.extension.dependency_injection"/>
            </argument>
        </service>
        <service id="ekyna_admin.show.renderer"
                 class="Ekyna\Bundle\AdminBundle\Show\Renderer"
                 public="false">
            <argument type="service" id="ekyna_admin.show.registry"/>
            <argument type="service" id="twig"/>
        </service>
        <service id="ekyna_admin.show_type.translations"
                 class="Ekyna\Bundle\AdminBundle\Show\Extension\Core\Type\TranslationsType">
            <argument>%locales%</argument>
            <tag name="ekyna_admin.show.type" alias="translations"/>
        </service>

        <!-- Serialization -->
        <service id="ekyna_admin.user.normalizer"
                 class="Ekyna\Bundle\AdminBundle\Service\Serializer\UserNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>

        <!-- Twig Extensions -->
        <service id="ekyna_admin.twig.admin_extension"
                 class="Ekyna\Bundle\AdminBundle\Twig\AdminExtension">
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="ekyna_admin.helper.pin_helper"/>
            <argument type="service" id="security.authorization_checker"/>
            <argument type="service" id="ekyna_core.ui.renderer"/>
            <argument>%ekyna_admin.config.front%</argument>
            <tag name="twig.extension"/>
        </service>
        <service id="ekyna_admin.twig.show_extension"
                 class="Ekyna\Bundle\AdminBundle\Twig\ShowExtension">
            <argument type="service" id="ekyna_admin.show.renderer"/>
            <tag name="twig.extension"/>
        </service>
        <service id="ekyna_dashboard_extension"
                 class="Ekyna\Bundle\AdminBundle\Twig\DashboardExtension">
            <tag name="twig.extension"/>
        </service>

        <!-- Dashboard -->
        <service id="ekyna_admin.dashboard.widget.registry"
                 class="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Registry">
            <argument type="collection"/>
        </service>
        <service id="ekyna_admin.dashboard.widget.factory"
                 class="Ekyna\Bundle\AdminBundle\Dashboard\Widget\Factory">
            <argument id="ekyna_admin.dashboard.widget.registry" type="service"/>
        </service>
        <service id="ekyna_admin.dashboard.factory"
                 class="Ekyna\Bundle\AdminBundle\Dashboard\Factory">
            <argument id="ekyna_admin.dashboard.widget.factory" type="service"/>
        </service>
        <service id="ekyna_admin.dashboard.widget.shortcuts"
                 class="Ekyna\Bundle\AdminBundle\Dashboard\Widget\ShortcutsWidgetType">
            <argument id="ekyna_admin.menu.pool" type="service"/>
            <argument id="ekyna_resource.configuration_registry" type="service"/>
            <argument id="security.authorization_checker" type="service"/>
            <argument id="router" type="service"/>
            <tag name="ekyna_admin.dashboard.widget_type" alias="admin_shortcuts"/>
        </service>

        <service id="ekyna_admin.dashboard"
                 class="Ekyna\Bundle\AdminBundle\Dashboard\Dashboard">
            <factory service="ekyna_admin.dashboard.factory" method="create"/>
            <argument>%ekyna_admin.config.dashboard%</argument>
        </service>

        <!-- Commands -->
        <service id="ekyna_admin.command.create_user"
                 class="Ekyna\Bundle\AdminBundle\Command\CreateUserCommand">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="ekyna_admin.group.repository"/>
            <argument type="service" id="ekyna_admin.user.operator"/>
            <tag name="console.command"/>
        </service>
        <service id="ekyna_admin.command.change_user_password"
                 class="Ekyna\Bundle\AdminBundle\Command\ChangeUserPasswordCommand">
            <argument type="service" id="ekyna_admin.user.repository"/>
            <argument type="service" id="ekyna_admin.user.operator"/>
            <tag name="console.command"/>
        </service>

    </services>

</container>
