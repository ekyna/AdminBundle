require(["require","jquery","routing","ekyna-api","bootstrap","jquery/form","ekyna-clipboard-copy","ekyna-spinner"],function(e,d,l,t){function c(e){let t,n;try{return t=window[e],n="__storage_test__",t.setItem(n,n),t.removeItem(n),1}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}t.init("admin_api_login"),d(document).ajaxError(function(e,t){403===t.status&&window.location.reload()});{const i=d("ul.nav-tabs[data-tab-key]");if(1===i.length&&c("localStorage")){const o=i.data("tab-key")+".tab_id";i.on("click","a",function(e){e.preventDefault(),d(this).tab("show");e=d(this).attr("id");e&&localStorage.setItem(o,e)});t=localStorage.getItem(o);t&&i.find("a#"+t).trigger("click")}}d("#sidebar-menu").on("click",".dropdown-toggle",function(e){e.preventDefault();const t=d(this).parent();t.toggleClass("active"),t.hasClass("active")?t.find(".submenu").slideDown("fast"):t.find(".submenu").slideUp("fast")});const u=d("#sidebar-nav"),n=(d("body").on("click",function(){d(this).hasClass("menu")&&d(this).removeClass("menu")}),u.on("click",function(e){e.stopPropagation()}),d("#menu-toggler").on("click",function(e){e.stopPropagation(),d("body").toggleClass("menu")}),d(window).on("resize",function(){769<d(this).width()&&d("body.menu").removeClass("menu")}),u.height()>d(".content").height()&&d("html").addClass("small"),d(document).on("select2:open",()=>{document.querySelector(".select2-container--open .select2-search__field").focus()}),d(document).on("click",".nav-tabs a",function(e){e.preventDefault(),d(this).tab("show")}),d("form")),f=(0<n.length&&e(["ekyna-form"],function(a){n.each(function(e,t){const n=a.create(t);n.init()})}),d(".ekyna-table"));0<f.length&&e(["ekyna-table"],function(n){f.each(function(e,t){n.create(t)})});try{e(["ekyna-media/thumb"],function(e){e.init()})}catch(e){console.log("Media thumb is not available.")}d(document).on("click","a[data-toggle-details]",function(e){e.preventDefault();e=d(this),e=d("#"+e.data("toggle-details"));return 1===e.length&&(e.is(":visible")?e.hide():e.show()),!1}),e(["ekyna-admin/summary"],function(e){e.init()}),e(["ekyna-admin/side-detail"],function(e){e.init()});const p=d("#barcode-scanner-button");e(["ekyna-admin/barcode-scanner"],function(e){e.init({}),e.addListener(function(e){p.find("> i").removeClass("fa-barcode").addClass("fa-spinner fa-pulse fa-3x fa-fw");const t=d.ajax({url:l.generate("admin_toolbar_barcode",{barcode:e}),method:"GET"});t.done(function(e,t,n){if("text/html"!==n.getResponseHeader("Content-Type")){if("application/json"!==n.getResponseHeader("Content-Type"))throw"Unexpected barcode response type";if(e.hasOwnProperty("results")&&0!==e.results.length)if(1!==e.results.length)e.results.forEach(function(e){});else if("redirect"===e.results[0].type)window.location.href=e.results[0].url;else{if("modal"!==e.results[0].type)throw"Unexpected result type";console.log("Not yet implemented")}}}),t.always(function(){p.find("> i").removeClass("fa-spinner fa-pulse fa-3x fa-fw").addClass("fa-barcode")})})}),function(){const e=d("#wide-search > form"),t=e.find("input[type=text]"),n=e.find("input[type=checkbox]"),a=e.find(".input-group-addon > i"),i=d("#wide-search > div.list-group");let o=!1,r,s;this.start=()=>{o=!0,a.removeClass("fa-search").addClass("fa-spinner fa-spin"),s&&clearTimeout(s),r&&r.abort(),s=setTimeout(this.search,300)},this.stop=function(){o=!1,a.removeClass("fa-spinner fa-spin").addClass("fa-search")},this.search=function(){i.empty(),""!==t.val()?((r=d.ajax({url:l.generate("admin_toolbar_search"),method:"POST",data:e.formSerialize(),dataType:"json"})).done(e=>{e.hasOwnProperty("results")&&0!==e.results.length&&(e.results.forEach(function(e){let t=d('<a class="list-group-item"></a>');e.icon&&d("<i></i>").addClass(e.icon).appendTo(t),t.append(document.createTextNode(e.title)),t.attr("href",e.url),t.appendTo(i)}),i.show())}),r.always(()=>this.stop())):this.stop()},this.init=function(){e.find(".dropdown-menu input, .dropdown-menu label").on("click",function(e){e.stopPropagation()}),e.on("submit",function(e){return e.preventDefault(),e.stopPropagation(),!1}),n.on("change",this.start),t.on("keyup",e=>{if(!/Key[A-Z]|Digit[0-9]|Numpad[0-9]|Space|Comma|Period|Semicolon|(Back)?Slash|Minus|Equal|IntlBackslash|Bracket(Left|Right)|Quote|Backspace/.test(e.code))return e.stopPropagation(),e.preventDefault(),!1;this.start()}),t.on("focus",()=>{if(i.is(":empty"))return""!==t.val()&&this.start(),!1;i.show()}),d(document).on("click",e=>{o||1!==d(e.target).closest("#wide-search").length&&i.hide()})},this.init()}();{const r=d(".navbar li.user-pins > div");function h(i){let o;if(i.hasOwnProperty("added")){let e=d('<span data-id="'+i.added.id+'"></span>'),t=d('<a href="'+i.added.path+'" title="'+i.added.label+'">'+i.added.label+"</a>"),n=l.generate("admin_pin_remove",{id:i.added.id}),a='<a href="'+n+'"><i class="fa fa-remove"></i></a>';e.append(t).append(a).prependTo(r),1===(o=d('a.user-pin[data-resource="'+i.added.resource+'"][data-identifier="'+i.added.identifier+'"]')).length&&o.addClass("unpin").attr("href",l.generate("admin_pin_resource_unpin",{name:i.added.resource,identifier:i.added.identifier}))}else i.hasOwnProperty("removed")&&(r.find("span[data-id="+i.removed.id+"]").remove(),1===(o=d('a.user-pin[data-resource="'+i.removed.resource+'"][data-identifier="'+i.removed.identifier+'"]')).length&&o.removeClass("unpin").attr("href",l.generate("admin_pin_resource_pin",{name:i.removed.resource,identifier:i.removed.identifier})))}d(document).on("click","a.user-pin",function(e){return e.preventDefault(),d.ajax({url:d(this).attr("href"),method:"GET",dataType:"json"}).done(h),!1}),d("li.user-pins").on("click","a:last-child",function(e){return e.preventDefault(),d.ajax({url:d(this).attr("href"),method:"GET",dataType:"json"}).done(h),!1})}{const s=d("#helper-content:visible");if(1===s.length&&c("localStorage")){let e=s.data("helper")||null;function a(e){s.empty(),function(t){if(!t)return Promise.reject("Empty reference");let i="ekyna_cms_helper["+t+"]",e=localStorage.getItem(i);if(e&&(e=JSON.parse(e)).expiresAt>Math.floor((new Date).getTime()/1e3))return Promise.resolve(e.content);s.loadingSpinner("on");const o=Math.floor((new Date).getTime()/1e3)+604800;return new Promise((a,e)=>{d.ajax({url:l.generate("ekyna_setting_api_helper_fetch"),data:{reference:t},type:"GET",dataType:"xml"}).done(function(e){let t=d(e).find("content"),n="";1===t.length&&(n=t.text()),localStorage.setItem(i,JSON.stringify({expiresAt:o,content:n})),a(n)}).fail(function(){localStorage.setItem(i,JSON.stringify({expiresAt:o,content:""})),e("Helper not found")}).always(function(){s.loadingSpinner("off")})})}(e).then(e=>{d("<div />").append(e).appendTo(s)}).catch(()=>{})}a(e),n.on("focus","*[data-helper]",function(){a(d(this).data("helper"))}).on("blur","*[data-helper]",function(){a(e)})}return}});